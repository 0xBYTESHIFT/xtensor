jobs:
  - job: 'Linux'
    strategy:
      matrix:
        clang_4:
          llvm_version: '6.0'
          CC: clang-$(llvm_version)
          CXX: clang++-$(llvm_version)
    pool:
      vmImage: ubuntu-16.04
    variables:
      CC: clang-$(llvm_version)
      CXX: clang++-$(llvm_version)
    timeoutInMinutes: 360
    steps:

      - script: |
          LLVM_VERSION=$(llvm_version)
          wget -O - http://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          sudo add-apt-repository "deb http://apt.llvm.org/xenial/ llvm-toolchain-xenial-$LLVM_VERSION main"
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test
          sudo apt-get update
          sudo apt-get --no-install-suggests --no-install-recommends install clang-$(llvm_version) 
        displayName: Install build toolchain

      - bash: echo "##vso[task.prependpath]$CONDA/bin"
        displayName: Add conda to PATH

      - script: |
          conda config --set always_yes yes --set changeps1 no
          conda update -q conda
          conda install cmake -c conda-forge
          conda install xtl==0.6.9 xsimd==7.4.4 nlohmann_json -c conda-forge
        displayName: Install dependencies

      - script: |
          mkdir build
          cd build
          cmake -DXTENSOR_USE_XSIMD=ON -DDOWNLOAD_GTEST=ON $(Build.SourcesDirectory)
        displayName: Configure xtensor
        workingDirectory: $(Build.BinariesDirectory)
      
      - script: |
          make -j2 test_xtensor_lib
        displayName: Build xtensor
        workingDirectory: $(Build.BinariesDirectory)/build
          
      - script: |
          cd test
          ./test_xtensor_lib
        displayName: Test xtensor
        workingDirectory: $(Build.BinariesDirectory)/build/test
